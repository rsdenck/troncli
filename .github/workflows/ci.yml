name: CI

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]

permissions:
  contents: read

jobs:
  lint:
    name: Static Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
      
      - name: Setup Go
        uses: actions/setup-go@41dfa10bad2bb2ae585af6ee5bb4e7d973ad74ed # v5.1.0
        with:
          go-version: '1.22'
          check-latest: true
          cache: true

      - name: Verify dependencies
        run: go mod verify

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@971e284b6050e8f58e33b11c2a050516b3b55866 # v6.1.1
        with:
          version: v6.1.1
          args: --config=.golangci.yml

      - name: Static Check
        run: go run honnef.co/go/tools/cmd/staticcheck@latest ./...

  test:
    name: Test & Coverage
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Go
        uses: actions/setup-go@41dfa10bad2bb2ae585af6ee5bb4e7d973ad74ed # v5.1.0
        with:
          go-version: '1.22'
          cache: true

      - name: Run Unit Tests
        run: |
          go test -race -v -coverprofile=coverage.out -covermode=atomic ./...
          go tool cover -func=coverage.out

      - name: Enforce Coverage
        run: |
          TOTAL_COVERAGE=$(go tool cover -func=coverage.out | grep total | grep -o '[0-9]*\.[0-9]*')
          if (( $(echo "$TOTAL_COVERAGE < 85.0" | bc -l) )); then
            echo "Coverage is below 85%: $TOTAL_COVERAGE%"
            exit 1
          fi

      - name: Run Benchmark Tests
        run: go test -bench=. -benchmem ./...

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Go
        uses: actions/setup-go@41dfa10bad2bb2ae585af6ee5bb4e7d973ad74ed # v5.1.0
        with:
          go-version: '1.22'

      - name: Govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./...

      - name: Trivy FS Scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          trivy-config: trivy.yaml
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

  build:
    name: Build Dry Run
    runs-on: ubuntu-latest
    needs: [lint, test, security]
    strategy:
      matrix:
        goos: [linux]
        goarch: [amd64, arm64]
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Go
        uses: actions/setup-go@41dfa10bad2bb2ae585af6ee5bb4e7d973ad74ed # v5.1.0
        with:
          go-version: '1.22'

      - name: Build
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          go build -trimpath -ldflags="-s -w" -o troncli-${{ matrix.goos }}-${{ matrix.goarch }} ./cmd/troncli
